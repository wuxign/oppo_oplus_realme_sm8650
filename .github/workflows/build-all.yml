name: ğŸš€ ç»Ÿä¸€æ„å»ºæ‰€æœ‰ç‰ˆæœ¬å†…æ ¸

permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:
    inputs:
      ksu_type:
        description: 'KernelSUåˆ†æ”¯'
        required: true
        type: choice
        default: 'sukisu'
        options:
          - 'sukisu'
          - 'ksunext'
          - 'mksu'
          - 'ksu'
      susfs_enable:
        description: 'æ˜¯å¦å¼€å¯susfs'
        required: true
        type: boolean
        default: true
      kpm_enable:
        description: 'æ˜¯å¦å¼€å¯kpm(ä»…å¯¹sukisuç”Ÿæ•ˆ)'
        required: true
        type: boolean
        default: false
      lz4_enable:
        description: 'æ˜¯å¦å®‰è£… lz4 1.10.0+zstd 1.5.7 è¡¥ä¸'
        required: true
        type: boolean
        default: true
      lz4kd_enable:
        description: 'æ˜¯å¦å®‰è£… LZ4KD è¡¥ä¸'
        required: true
        type: boolean
        default: false
      bbr_enable:
        description: 'BBRç®—æ³•(falseå…³é—­/trueä»…åŠ å…¥/defaultè®¾ä¸ºé»˜è®¤)'
        required: true
        type: choice
        default: 'false'
        options:
          - 'false'
          - 'true'
          - 'default'
      better_net:
        description: 'æ˜¯å¦å¼€å¯ç½‘ç»œåŠŸèƒ½æ‹“å±•é…ç½®'
        required: true
        type: boolean
        default: false
      ssg_enable:
        description: 'æ˜¯å¦å¯ç”¨ä¸‰æ˜ŸSSG IOè°ƒåº¦å™¨æ”¯æŒ'
        required: true
        type: boolean
        default: true
      rekernel_enable:
        description: 'æ˜¯å¦å¯ç”¨Re-Kernelæ”¯æŒ'
        required: true
        type: boolean
        default: false
      baseband_guard:
        description: 'æ˜¯å¦å¼€å¯å†…æ ¸çº§åŸºå¸¦ä¿æŠ¤'
        required: true
        type: boolean
        default: true
      # é€‰æ‹©è¦æ„å»ºçš„ç‰ˆæœ¬ - æ”¯æŒ: 57 75 115 118 128 134 æˆ– all
      build_versions:
        description: 'æ„å»ºç‰ˆæœ¬(ç©ºæ ¼åˆ†éš”,å¦‚: 75 57 æˆ– allæ„å»ºå…¨éƒ¨)'
        required: true
        type: string
        default: '75'
      kernel_suffix:
        description: 'è‡ªå®šä¹‰å†…æ ¸åç¼€(ç•™ç©ºä½¿ç”¨é»˜è®¤)'
        required: false
        type: string
        default: ''

env:
  TZ: Asia/Shanghai

jobs:
  # ==================== 6.1.57 ====================
  build-6-1-57:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '57') }}
    uses: ./.github/workflows/fastbuild_6.1.57.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      ssg_enable: ${{ inputs.ssg_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}

  # ==================== 6.1.75 ====================
  build-6-1-75:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '75') }}
    uses: ./.github/workflows/fastbuild_6.1.75.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      ssg_enable: ${{ inputs.ssg_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}

  # ==================== 6.1.115 ====================
  build-6-1-115:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '115') }}
    uses: ./.github/workflows/fastbuild_6.1.115.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      ssg_enable: ${{ inputs.ssg_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}

  # ==================== 6.1.118 ====================
  build-6-1-118:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '118') }}
    uses: ./.github/workflows/fastbuild_6.1.118.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      ssg_enable: ${{ inputs.ssg_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}

  # ==================== 6.1.128 ====================
  build-6-1-128:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '128') }}
    uses: ./.github/workflows/fastbuild_6.1.128.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      ssg_enable: ${{ inputs.ssg_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}

  # ==================== 6.1.134 ====================
  build-6-1-134:
    if: ${{ inputs.build_versions == 'all' || contains(inputs.build_versions, '134') }}
    uses: ./.github/workflows/fastbuild_6.1.134.yml
    secrets: inherit
    with:
      ksu_type: ${{ inputs.ksu_type }}
      susfs_enable: ${{ inputs.susfs_enable }}
      kpm_enable: ${{ inputs.kpm_enable }}
      lz4_enable: ${{ inputs.lz4_enable }}
      lz4kd_enable: ${{ inputs.lz4kd_enable }}
      bbr_enable: ${{ inputs.bbr_enable }}
      better_net: ${{ inputs.better_net }}
      ssg_enable: ${{ inputs.ssg_enable }}
      rekernel_enable: ${{ inputs.rekernel_enable }}
      baseband_guard: ${{ inputs.baseband_guard }}
      kernel_suffix: ${{ inputs.kernel_suffix }}

  # ==================== ç»Ÿä¸€å‘å¸ƒ ====================
  release:
    runs-on: ubuntu-latest
    needs: 
      - build-6-1-57
      - build-6-1-75
      - build-6-1-115
      - build-6-1-118
      - build-6-1-128
      - build-6-1-134
    if: |
      always() && 
      (needs.build-6-1-57.result == 'success' || needs.build-6-1-57.result == 'skipped') &&
      (needs.build-6-1-75.result == 'success' || needs.build-6-1-75.result == 'skipped') &&
      (needs.build-6-1-115.result == 'success' || needs.build-6-1-115.result == 'skipped') &&
      (needs.build-6-1-118.result == 'success' || needs.build-6-1-118.result == 'skipped') &&
      (needs.build-6-1-128.result == 'success' || needs.build-6-1-128.result == 'skipped') &&
      (needs.build-6-1-134.result == 'success' || needs.build-6-1-134.result == 'skipped') &&
      (needs.build-6-1-57.result == 'success' || needs.build-6-1-75.result == 'success' || 
       needs.build-6-1-115.result == 'success' || needs.build-6-1-118.result == 'success' ||
       needs.build-6-1-128.result == 'success' || needs.build-6-1-134.result == 'success')
    permissions:
      contents: write
      packages: write
      actions: read
      
    steps:
      - name: ä¸‹è½½æ‰€æœ‰å†…æ ¸å·¥ä»¶
        uses: actions/download-artifact@v4
        with:
          path: ./release_zips
          pattern: Kernel_*
          merge-multiple: true

      - name: åˆ—å‡ºå·²ä¸‹è½½çš„æ–‡ä»¶
        run: |
          echo "å·²ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨:"
          find ./release_zips -type f -name "*.zip" | sort

      - name: è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          TIME="$(TZ='Asia/Shanghai' date +'%y%m%d%H%M%S')"
          TIME_FORM="$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')"
          echo "TIME=$TIME" >> $GITHUB_ENV
          echo "TIME_FORM=$TIME_FORM" >> $GITHUB_ENV
          TAG_HEAD="OPPO+OPlus+Realme-A15-build"
          echo "TAG_HEAD=$TAG_HEAD" >> $GITHUB_ENV
          
          # ç¡®å®š KSU ç±»å‹åç§°
          if [[ "${{ inputs.ksu_type }}" == "sukisu" ]]; then
            KSU_TYPENAME="SukiSU Ultra"
          elif [[ "${{ inputs.ksu_type }}" == "ksunext" ]]; then
            KSU_TYPENAME="KernelSU Next"
          elif [[ "${{ inputs.ksu_type }}" == "mksu" ]]; then
            KSU_TYPENAME="MKSU"
          else
            KSU_TYPENAME="KernelSU (Official)"
          fi
          echo "KSU_TYPENAME=$KSU_TYPENAME" >> $GITHUB_ENV
          
          # æ„å»ºç‰ˆæœ¬åˆ—è¡¨
          VERSIONS=""
          BUILD_VERSIONS="${{ inputs.build_versions }}"
          if [[ "$BUILD_VERSIONS" == "all" ]]; then
            VERSIONS="6.1.57 6.1.75 6.1.115 6.1.118 6.1.128 6.1.134"
          else
            if [[ "$BUILD_VERSIONS" == *"57"* ]]; then
              VERSIONS="${VERSIONS}6.1.57 "
            fi
            if [[ "$BUILD_VERSIONS" == *"75"* ]]; then
              VERSIONS="${VERSIONS}6.1.75 "
            fi
            if [[ "$BUILD_VERSIONS" == *"115"* ]]; then
              VERSIONS="${VERSIONS}6.1.115 "
            fi
            if [[ "$BUILD_VERSIONS" == *"118"* ]]; then
              VERSIONS="${VERSIONS}6.1.118 "
            fi
            if [[ "$BUILD_VERSIONS" == *"128"* ]]; then
              VERSIONS="${VERSIONS}6.1.128 "
            fi
            if [[ "$BUILD_VERSIONS" == *"134"* ]]; then
              VERSIONS="${VERSIONS}6.1.134 "
            fi
          fi
          echo "VERSIONS=$VERSIONS" >> $GITHUB_ENV

      - name: åˆ›å»ºç»Ÿä¸€å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "${{ env.TAG_HEAD }}-${{ env.TIME }}"
          name: "ğŸš€ ${{ env.KSU_TYPENAME }} å¤šç‰ˆæœ¬ç»Ÿä¸€æ„å»º - ${{ env.TIME_FORM }}"
          body: |
            ### ğŸ“± æ¬§åŠ çœŸ ${{ env.KSU_TYPENAME }} SM8650 é€šç”¨å†…æ ¸ | ç»Ÿä¸€æ„å»º
            
            #### ğŸ“¦ æœ¬æ¬¡æ„å»ºåŒ…å«ä»¥ä¸‹ç‰ˆæœ¬:
            ${{ env.VERSIONS }}
            
            #### âš™ï¸ æ„å»ºé…ç½®:
            | é…ç½®é¡¹ | çŠ¶æ€ |
            |--------|------|
            | KSUåˆ†æ”¯ | ${{ env.KSU_TYPENAME }} |
            | susfsæ”¯æŒ | ${{ inputs.susfs_enable && 'âœ…' || 'âŒ' }} |
            | KPMæ”¯æŒ | ${{ inputs.kpm_enable && 'âœ…' || 'âŒ' }} |
            | LZ4 1.10.0 + ZSTD | ${{ inputs.lz4_enable && 'âœ…' || 'âŒ' }} |
            | LZ4KD | ${{ inputs.lz4kd_enable && 'âœ…' || 'âŒ' }} |
            | ç½‘ç»œåŠŸèƒ½å¢å¼º | ${{ inputs.better_net && 'âœ…' || 'âŒ' }} |
            | BBRç®—æ³• | ${{ inputs.bbr_enable }} |
            | SSG IOè°ƒåº¦å™¨ | ${{ inputs.ssg_enable && 'âœ…' || 'âŒ' }} |
            | Re-Kernel | ${{ inputs.rekernel_enable && 'âœ…' || 'âŒ' }} |
            | åŸºå¸¦ä¿æŠ¤ | ${{ inputs.baseband_guard && 'âœ…' || 'âŒ' }} |
            
            #### ğŸ“¥ ç®¡ç†å™¨ä¸‹è½½:
            - SukiSU Ultra: [ä¸‹è½½](https://github.com/SukiSU-Ultra/SukiSU-Ultra/releases)
            - KernelSU Next: [ä¸‹è½½](https://github.com/KernelSU-Next/KernelSU-Next/releases)
            - MKSU: [ä¸‹è½½](https://github.com/5ec1cff/KernelSU/actions)
            - KernelSU åŸç‰ˆ: [ä¸‹è½½](https://github.com/tiann/KernelSU/releases)
            
            #### ğŸ“‹ å®‰è£…æ–¹æ³•:
            1. å·²æœ‰Recovery(TWRP): ä¸‹è½½å¯¹åº”ç‰ˆæœ¬AnyKernelåŒ…ï¼Œè¿›å…¥Recoveryåˆ·å…¥
            2. å·²Root: ä½¿ç”¨[HorizonKernelFlasher](https://github.com/libxzr/HorizonKernelFlasher/releases)åˆ·å…¥
            3. SukiSUç”¨æˆ·: å¯åœ¨ç®¡ç†å™¨ä¸­ç›´æ¥åˆ·å…¥
            
            #### âš ï¸ æ³¨æ„äº‹é¡¹:
            - åˆ·å†™å†…æ ¸æœ‰é£é™©ï¼Œè¯·å…ˆå¤‡ä»½bootåˆ†åŒºï¼
            - è¯·ä½¿ç”¨[KernelFlasher](https://github.com/capntrips/KernelFlasher)å¤‡ä»½
            - æ–°ç‰ˆKSUéœ€è¦é…åˆå…ƒæ¨¡å—ä½¿ç”¨
            
            ---
            ğŸ• ç¼–è¯‘æ—¶é—´: ${{ env.TIME_FORM }}
          draft: false
          prerelease: false
          files: |
            release_zips/*.zip
